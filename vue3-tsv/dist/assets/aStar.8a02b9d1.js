var J=Object.defineProperty;var M=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var T=(p,t,e)=>t in p?J(p,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[t]=e,B=(p,t)=>{for(var e in t||(t={}))Q.call(t,e)&&T(p,e,t[e]);if(M)for(var e of M(t))K.call(t,e)&&T(p,e,t[e]);return p};var o=(p,t,e)=>(T(p,typeof t!="symbol"?t+"":t,e),e);import{F as W,J as D,O as X,N as P,ah as Y,L as tt}from"./shared/aStar/chartGraph.723c646f.js";import{_ as et}from"./about.45dbf088.js";import{d as st,u as rt,e as ot,l as R,P as _,Q as it,c as j,a as E,F as nt,g as at,p as N,k as F,r as ht,o as $,S as lt,t as ct}from"./common.80d79def.js";import"./chartGraph.a9c4b756.js";var pt=Object.defineProperty,ut=Object.getOwnPropertyDescriptor,S=(p,t,e,s)=>{for(var r=s>1?void 0:s?ut(t,e):t,i=p.length-1,a;i>=0;i--)(a=p[i])&&(r=(s?a(t,e,r):a(r))||r);return s&&r&&pt(t,e,r),r};const Z=1e-6;function I(p){return(t,e)=>{t[e]=p}}class w{constructor(t,e){o(this,"zshape");o(this,"tshape");o(this,"rshape");o(this,"rate",0);o(this,"value");o(this,"empty",!0);o(this,"isRemove",!1);o(this,"itemColor");o(this,"type");o(this,"emptyColor","");o(this,"groundColor","");o(this,"removeColor","");o(this,"lucencyColor","");o(this,"sourceColor","");o(this,"targetColor","");this.coord=t;const s=this;Object.prototype.hasOwnProperty.call(this,"emptyColor")&&delete s.emptyColor,Object.prototype.hasOwnProperty.call(this,"groundColor")&&delete s.groundColor,Object.prototype.hasOwnProperty.call(this,"removeColor")&&delete s.removeColor,Object.prototype.hasOwnProperty.call(this,"lucencyColor")&&delete s.lucencyColor,Object.prototype.hasOwnProperty.call(this,"sourceColor")&&delete s.sourceColor,Object.prototype.hasOwnProperty.call(this,"targetColor")&&delete s.targetColor,this.rate=0,this.value=0,this.empty=!0,this.itemColor=this.getItemColor(),this.type="Ground";const r={fill:this.itemColor,stroke:"none"},i={fill:this.lucencyColor,stroke:"none"},a=(e.gep+e.size)*t.x+e.gep,c=(e.gep+e.size)*t.y+e.gep;let u,y;switch(e.shape){case"Rect":{const l={x:a,y:c,r:e.size*.2,width:e.size,height:e.size};u=new D({shape:l,style:r}),y=new D({shape:l,style:i})}break;case"Circle":default:{const l={cx:a+e.size/2,cy:c+e.size/2,r:e.size/2};u=new W({shape:l,style:r}),y=new W({shape:l,style:i})}break}this.zshape=u,this.rshape=y,this.tshape=new X({x:a,y:c,style:{text:"",fontSize:12,opacity:.4}})}rangeTrans(t,e,s,r,i){const a=(i-r)/(s-e),c=r-a*e;return a*t+c}rate2color(t){const e=this.rangeTrans(this.rate,0,1,240,0),s=this.rangeTrans(this.rate,0,1,95,70);return`hsl(${e},100%,${s}%)`}getItemColor(){return this.type==="Wall"?this.groundColor:this.type==="Source"?this.sourceColor:this.type==="Target"?this.targetColor:this.empty?this.emptyColor:this.rate2color(this.rate)}itemRefresh(){this.itemColor=this.getItemColor(),this.zshape.attr("style",{fill:this.itemColor}),this.type==="Ground"&&!this.empty&&this.value!==void 0?this.tshape.attr("style",{text:this.value.toFixed(0)}):this.tshape.attr("style",{text:""}),this.type==="Ground"&&!this.empty&&this.isRemove?this.rshape.attr("style",{fill:this.removeColor}):this.rshape.attr("style",{fill:this.lucencyColor})}setRate(t,e,s=!1){if(this.type!=="Ground")throw new Error("item is not ground");this.rate=t,this.value=e,this.empty=!1,this.isRemove=s,this.itemRefresh()}setEmpty(t){this.empty=t,t?this.type="Ground":this.rate=0,this.itemRefresh()}setType(t){this.type=t,this.itemRefresh()}}S([I("#eee")],w.prototype,"emptyColor",2);S([I("#333")],w.prototype,"groundColor",2);S([I("#33333333")],w.prototype,"removeColor",2);S([I("#00000000")],w.prototype,"lucencyColor",2);S([I("hsl(240,100%,55%)")],w.prototype,"sourceColor",2);S([I("hsl(0,100%,55%)")],w.prototype,"targetColor",2);class dt{constructor(t,e={gep:3,size:15,shape:"Circle"}){o(this,"cfg");o(this,"zr");o(this,"shapes",[]);o(this,"shapesCoord",[]);o(this,"controllerSet",new Set);o(this,"mousedown",!1);o(this,"sourceInfo");o(this,"targetInfo");o(this,"priorityGroup",new P({silent:!0}));o(this,"removeGroup",new P({silent:!0}));o(this,"path",[]);o(this,"pathShape");const s=t.clientWidth,r=t.clientHeight;this.cfg={gep:e.gep,size:e.size,shape:e.shape,width:s,height:r,widthCnt:Math.floor(s/(e.gep+e.size)),heightCnt:Math.floor(r/(e.gep+e.size))},this.zr=Y(t);for(let i=0;i<this.cfg.heightCnt;i++){const a=[];this.shapesCoord.push(a);for(let c=0;c<this.cfg.widthCnt;c++){const u=new w({x:c,y:i},this.cfg);this.shapes.push(u),a.push(u),this.zr.add(u.zshape),this.removeGroup.add(u.rshape),this.priorityGroup.add(u.tshape)}}this.zr.add(this.removeGroup),this.zr.add(this.priorityGroup),this.registerControllerEvent("click"),this.zr.on("mousedown",()=>{this.mousedown=!0}),this.zr.on("mousemove",i=>{this.mousedown&&this.controllerSet.forEach(a=>{const c=a.mousedrag;c&&c(i)})}),this.zr.on("mouseup",()=>{this.mousedown=!1})}registerControllerEvent(t){const e=this;this.zr.on(t,s=>{e.controllerSet.forEach(r=>{const i=r[t];i&&i(s)})})}addController(t){this.controllerSet.add(t)}removeController(t){this.controllerSet.delete(t)}setWall(t){var e,s;((e=this.sourceInfo)==null?void 0:e.index)!==t&&((s=this.targetInfo)==null?void 0:s.index)!==t&&this.shapes[t].setType("Wall")}setGround(t){var e,s;((e=this.sourceInfo)==null?void 0:e.index)!==t&&((s=this.targetInfo)==null?void 0:s.index)!==t&&this.shapes[t].setType("Ground")}setSource(t){this.sourceInfo&&this.sourceInfo.item.setEmpty(!0),this.shapes[t].setType("Source"),this.sourceInfo={item:this.shapes[t],index:t}}setTarget(t){this.targetInfo&&this.targetInfo.item.setEmpty(!0),this.shapes[t].setType("Target"),this.targetInfo={item:this.shapes[t],index:t}}setRate(t,e,s,r=!1){this.shapes[t].setRate(e,s,r)}destroy(){this.zr.dispose()}coord2point(t){const e=this.cfg,s=(e.gep+e.size)*t.x+e.gep+e.size/2,r=(e.gep+e.size)*t.y+e.gep+e.size/2;return{x:s,y:r}}showPriority(t){t?this.priorityGroup.show():this.priorityGroup.hide()}showRemove(t){t?this.removeGroup.show():this.removeGroup.hide()}drawPath(t){const e={stroke:"#1b2",lineWidth:2};if(t.length<2)throw new Error("path is too short");this.pathShape&&(this.zr.remove(this.pathShape),this.pathShape=void 0,this.path=[]);let s=this.coord2point(t[0]);this.path=t,this.pathShape=new P({silent:!0});for(let r=1;r<t.length;r++){const i=this.coord2point(t[r]),a={shape:{x1:s.x,y1:s.y,x2:i.x,y2:i.y},style:e,silent:!0};this.pathShape.add(new tt(a)),s=i}this.zr.add(this.pathShape)}clearRes(){this.shapes.forEach(t=>{t.type==="Ground"&&t.setEmpty(!0)}),this.pathShape&&(this.zr.remove(this.pathShape),this.pathShape=void 0,this.path=[])}clearAll(){this.shapes.forEach(t=>{t.type="Ground",t.setEmpty(!0)}),this.pathShape&&(this.zr.remove(this.pathShape),this.pathShape=void 0,this.path=[]),this.sourceInfo=void 0,this.targetInfo=void 0}}class L{constructor(t="Ground"){o(this,"gpriority");o(this,"hpriority");o(this,"childCnt",0);o(this,"parent");this.type=t}get fpriority(){if(!(this.gpriority===void 0||this.hpriority===void 0))return this.gpriority+this.hpriority}clone(){const t=new L(this.type);for(const e of Object.keys(this))t[e]=this[e];return t}set(t){for(const e of Object.keys(this))this[e]=t[e]}}class ft{constructor(t,e){o(this,"width");o(this,"height");o(this,"mapArr",[]);o(this,"openSet",{});o(this,"closeSet",{});o(this,"openIndexList",[]);o(this,"removeSet",new Set);o(this,"sourceInfo");o(this,"targetInfo");o(this,"state","Editing");this.width=t,this.height=e;for(let s=0;s<this.height;s++){const r=[];this.mapArr.push(r);for(let i=0;i<this.width;i++){const a=new L;r.push(a)}}this.state="Editing"}index2xy(t){const e=t%this.width,s=Math.floor(t/this.width);return{x:e,y:s}}setWall(t){const{x:e,y:s}=this.index2xy(t),r=this.mapArr[s][e];r.type="Wall"}setGround(t){const{x:e,y:s}=this.index2xy(t),r=this.mapArr[s][e];r.type="Ground"}setSource(t){const{x:e,y:s}=this.index2xy(t),r=this.mapArr[s][e];r.type="Source",this.sourceInfo={item:r,x:e,y:s,index:t}}setTarget(t){const{x:e,y:s}=this.index2xy(t),r=this.mapArr[s][e];r.type="Target",this.targetInfo={item:r,x:e,y:s,index:t}}getItem(t){const{x:e,y:s}=this.index2xy(t);try{return{x:e,y:s,item:this.mapArr[s][e]}}catch{return}}getItemCoord(t){if(!(t.x>=this.width||t.x<0||t.y>=this.height||t.y<0))return this.mapArr[t.y][t.x]}openListGet(t){const e=this.openIndexList[t];if(e===void 0)return;const[s,r]=e.split("-").map(i=>Number(i));if(!(s===void 0||r===void 0))return{key:e,x:s,y:r,item:this.mapArr[r][s]}}coordTest(t){return t.x>=0&&t.x<this.width&&t.y>=0&&t.y<this.height}clearRes(){this.mapArr.forEach(t=>{t.forEach(e=>{e.gpriority=void 0,e.hpriority=void 0,e.parent=void 0,e.childCnt=0})}),this.openSet={},this.openIndexList=[],this.closeSet={},this.state="Editing"}clearAll(){this.mapArr.forEach(t=>{t.forEach(e=>{e.type="Ground",e.gpriority=void 0,e.hpriority=void 0,e.parent=void 0})}),this.openSet={},this.openIndexList=[],this.closeSet={},this.state="Editing",this.sourceInfo=void 0,this.targetInfo=void 0}setItem(t,e){t.item.gpriority=this.gpMath(t,e),t.item.hpriority=this.hpMath(t),t.item.parent={x:e.x,y:e.y}}getItemPriority(t,e){if(!this.targetInfo)throw new Error("targetInfo is undefined");if(e.item.gpriority===void 0)throw new Error("parentInfo.item.gpriority is undefined");if(!this.coordTest(t))return{state:"over"};const s=this.mapArr[t.y][t.x].clone();if(s.type==="Wall")return{state:"wall",item:s};let r="update";const i=t.x+"-"+t.y;if(this.closeSet[i])return{state:"close",item:s};this.openSet[i]&&(r="open");const a=B({item:s},t);if(r=="update"&&this.stepTest){const c=this.stepTest(a,e);if(c)return c}return this.setItem(a,e),{state:r,item:s}}runInit(){if(!this.sourceInfo)throw new Error("sourceInfo is undefined");if(!this.targetInfo)throw new Error("targetInfo is undefined");const t=this.sourceInfo.x+"-"+this.sourceInfo.y;this.openSet={[t]:this.sourceInfo.item},this.openIndexList=[t],this.closeSet={},this.removeSet=new Set,this.sourceInfo.item.hpriority=this.getDistance(this.sourceInfo,this.targetInfo),this.sourceInfo.item.gpriority=0,this.state="Running"}runStep(){this.state==="Editing"&&this.runInit();const t=this.openListGet(0);if(!t)return this.state="Never",{state:"Never"};if(!this.targetInfo)throw new Error("targetInfo is undefined");const{item:e,x:s,y:r}=t,i=this.getChilds(s,r);let a=!1;const c=[],u=[];i.forEach(l=>{const d=this.getItemPriority(l,{x:s,y:r,item:e}),g=l.x+"-"+l.y;let z=!1;if(u.push(d.state),d.state==="open"){if(d.item.fpriority<this.openSet[g].fpriority){z=!0;const v=this.openSet[g].parent&&this.getItemCoord(this.openSet[g].parent);v&&(v.childCnt-=1),t.item.childCnt+=1}}else d.state==="update"?(z=!0,t.item.childCnt+=1):d.state=="close"&&d.item.childCnt==0&&this.removeSet.add(g);if(z&&d.state!="over"){let v;this.mapArr[l.y][l.x].set(d.item),d.item=this.mapArr[l.y][l.x];const A=this.openSet[g];this.openSet[g]=d.item;let f=0;for(f=0;f<this.openIndexList.length;f++){const x=this.openListGet(f);if(!!x&&(x.item.fpriority>d.item.fpriority||Math.abs(x.item.fpriority-d.item.fpriority)<Z&&x.item.gpriority<d.item.gpriority)){this.openIndexList.splice(f,0,g),v=f;break}}if(A)for(f++;f<this.openIndexList.length;f++)this.openIndexList[f]==g&&this.openIndexList.splice(f,1);v===void 0&&this.openIndexList.push(g),c.push({x:l.x,y:l.y}),l.x===this.targetInfo.x&&l.y===this.targetInfo.y&&(a=!0)}});const y=s+"-"+r;for(let l=0;l<this.openIndexList.length;l++)if(this.openIndexList[l]===y){this.openIndexList.splice(l,1);break}return delete this.openSet[y],this.closeSet[y]=e,e.childCnt==0&&this.removeSet.add(y),this.state=a?"Done":"Running",{stae:this.state,update:c,gpriority:e.gpriority}}getPath(){if(!this.targetInfo)throw new Error("targetInfo is undefined");if(this.state!=="Done")throw new Error("state is not Done");const t=[];let e=this.targetInfo.item;for(t.push({x:this.targetInfo.x,y:this.targetInfo.y});e.parent;)t.push({x:e.parent.x,y:e.parent.y}),e=this.mapArr[e.parent.y][e.parent.x];return t.reverse(),t}removeTest(){console.log("removeList.length",this.removeSet.size);const t=Array.from(this.removeSet);for(let e=0;e<t.length;e++){const s=t[e],[r,i]=s.split("-").map(y=>Number(y)),a=this.getItemCoord({x:r,y:i});if(!a.parent)continue;const c=this.getItemCoord(a.parent),u=a.parent.x+"-"+a.parent.y;c.childCnt-=1,c.childCnt<=0&&(this.removeSet.has(u)||this.removeSet.add(u),t.push(u))}console.log("removeTest",this.removeSet)}}class yt extends ft{getDistance(t,e){const s=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y),i=Math.min(s,r);return s+r+(Math.sqrt(2)-2)*i}gpMath(t,e){return t.x===e.x||t.y===e.y?1+e.item.gpriority:Math.sqrt(2)+e.item.gpriority}hpMath(t){return this.getDistance(t,this.targetInfo)}getChilds(t,e){return[{x:t-1,y:e},{x:t+1,y:e},{x:t,y:e-1},{x:t,y:e+1},{x:t-1,y:e-1},{x:t+1,y:e+1},{x:t+1,y:e-1},{x:t-1,y:e+1}]}stepTest(t,e){if(!(t.x===e.x||t.y===e.y)){const s=this.getItemCoord({x:t.x,y:e.y}),r=this.getItemCoord({x:e.x,y:t.y});if(!s||!r||s.type==="Wall"&&r.type==="Wall")return{state:"wall",item:t.item}}}}class gt{constructor(t,e={gep:3,size:15,shape:"Circle",astar:yt}){o(this,"astar");o(this,"canvas");o(this,"gradientRow",[]);o(this,"maxGpriority",0);this.canvas=new dt(t,e);const s=this.canvas.cfg.widthCnt,r=this.canvas.cfg.heightCnt;this.astar=new e.astar(s,r)}get widthCnt(){return this.canvas.cfg.widthCnt}get heightCnt(){return this.canvas.cfg.heightCnt}addController(t){this.canvas.addController(t)}removeController(t){this.canvas.removeController(t)}getZshapeInfo(t){const e=this.canvas.shapes.findIndex(i=>i.zshape.id===t.id);if(e<1)return null;const s=e%this.widthCnt,r=Math.floor(e/this.widthCnt);return{index:e,x:s,y:r,astarItem:this.astar.mapArr[r][s],canvasItem:this.canvas.shapes[e]}}setWall(t){this.astar.setWall(t),this.canvas.setWall(t)}setGround(t){this.astar.setGround(t),this.canvas.setGround(t)}setSource(t){this.astar.setSource(t),this.canvas.setSource(t)}setTarget(t){this.astar.setTarget(t),this.canvas.setTarget(t)}run(){const t=[];let e=[],s=-1;for(;this.astar.state!=="Done"&&this.astar.state!=="Never";){const r=this.astar.runStep();r.update&&(Math.abs(r.gpriority-s)>Z?(e.length&&t.push(e),e=r.update.concat(),s=r.gpriority):e=e.concat(r.update))}this.gradientRow=t,this.maxGpriority=s,this.astar.removeTest()}*drawGradientRow(){for(let t=0;t<this.gradientRow.length;t++)this.gradientRow[t].forEach(e=>{const{x:s,y:r}=e,i=this.astar.mapArr[r][s];if(i.gpriority===void 0)throw new Error("item.gpriority is undefined");i.type==="Ground"&&this.canvas.setRate(s+r*this.widthCnt,i.gpriority/this.maxGpriority,i.gpriority,Boolean(this.astar.closeSet[`${s}-${r}`]&&i.childCnt<=0))}),yield this.gradientRow[t]}drawPath(){if(this.astar.state==="Done"){const t=this.astar.getPath();this.canvas.drawPath(t)}}clearRes(){this.canvas.clearRes(),this.astar.clearRes()}clearAll(){this.canvas.clearAll(),this.astar.clearAll()}destroy(){this.canvas.destroy()}}const mt={class:"component-a-star flex-layout frow"},vt={class:"tool flex-none"},Ct=["onClick"],wt={class:"tool-item"},xt=F(" \u663E\u793A\u4EE3\u4EF7 "),St={class:"tool-item"},It=F(" \u663E\u793A\u5185\u5B58\u4F18\u5316 "),zt=st({__name:"aStar",props:{},emits:[],setup(p,{emit:t}){rt(),ot();const e=R(null);let s=null;function r(h){if(h.target&&s){const n=s.getZshapeInfo(h.target);n&&s.setWall(n.index)}}const i={click:r,mousedrag:r};function a(h){if(h.target&&s){const n=s.getZshapeInfo(h.target);n&&s.setGround(n.index)}}const c={click:a,mousedrag:a};function u(h){if(h.target&&s){const n=s.getZshapeInfo(h.target);n&&s.setSource(n.index)}}const y={click:u};function l(h){if(h.target&&s){const n=s.getZshapeInfo(h.target);n&&s.setTarget(n.index)}}const d={click:l};async function g(h){return new Promise(n=>setTimeout(n,h))}async function z(){if(!s)return;s.clearRes(),s.run();const h=s.drawGradientRow();let n=0;for(let C of h)n+=C.length,n>10&&(n=0,await g(50));s.drawPath()}const v={btnClick:z};function A(h){if(h.target&&s){const n=s.getZshapeInfo(h.target);if(!n)return;const C=`${n.x}-${n.y}`;console.log(`info isOpen:${Boolean(s.astar.openSet[C])} isClose:${Boolean(s.astar.closeSet[C])}`,n.x,n.y,n.astarItem,s.canvas.shapesCoord[n.y][n.x])}}const f={click:A};function x(){s&&s.clearRes()}const H={btnClick:x};function U(){s&&s.clearAll()}const O=[{title:"\u5899",value:"wall",zcontroller:i},{title:"\u5730\u9762",value:"ground",zcontroller:c},{title:"\u8D77\u70B9",value:"source",zcontroller:y},{title:"\u7EC8\u70B9",value:"target",zcontroller:d},{title:"\u8BA1\u7B97",value:"run",zcontroller:f,dcontroller:v},{title:"\u6E05\u9664\u8BA1\u7B97",value:"clearRes",dcontroller:H},{title:"\u6E05\u9664\u5168\u90E8",value:"clearAll",dcontroller:{btnClick:U}}],k=R(O[0]);_(e,()=>{!e.value||(s=new gt(e.value),k.value.zcontroller&&s.addController(k.value.zcontroller),V())});function V(){!s||(s.setSource(2),s.setTarget(s.widthCnt*(s.heightCnt-2)+s.widthCnt-2))}it(()=>{s&&s.destroy()});function q(h){var n;k.value=h,(n=h.dcontroller)!=null&&n.btnClick&&h.dcontroller.btnClick()}_(k,(h,n)=>{s&&(n&&n.zcontroller&&s.removeController(n.zcontroller),h.zcontroller&&s.addController(h.zcontroller))},{immediate:!0});const G=R(!0);_(G,h=>{s&&s.canvas.showPriority(h)});const b=R(!0);return _(b,h=>{s&&s.canvas.showRemove(h)}),(h,n)=>{const C=ht("a-switch");return $(),j("div",mt,[E("div",vt,[($(),j(nt,null,at(O,m=>E("div",{key:m.value,class:lt(["tool-item",{active:k.value.value===m.value}]),onClick:Et=>q(m)},ct(m.title),11,Ct)),64)),E("div",wt,[xt,N(C,{checked:G.value,"onUpdate:checked":n[0]||(n[0]=m=>G.value=m),size:"small"},null,8,["checked"])]),E("div",St,[It,N(C,{checked:b.value,"onUpdate:checked":n[1]||(n[1]=m=>b.value=m),size:"small"},null,8,["checked"])])]),E("div",{class:"zrader flex-auto",ref_key:"zrRef",ref:e},null,512)])}}});var Tt=et(zt,[["__scopeId","data-v-edc27fc0"]]);export{Tt as default};
